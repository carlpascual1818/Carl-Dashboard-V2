<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Role Hub</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg:#fbf7f3;
      --panel:#ffffff;
      --text:#1e1b16;
      --muted:#6B6560;
      --border:#E0DAD3;
      --accent:#C86A4A;
      --accent2:#E3B193;
      --shadow: 0 10px 30px rgba(30,27,22,.06);
      --radius:16px;
      --green:#16a34a;
      --red:#ef4444;
      --blue:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    .app{display:flex;min-height:100vh}
    .sidebar{width:280px;background:#14110f;color:#fff;padding:18px 14px;position:sticky;top:0;height:100vh}
    .brand{display:flex;align-items:center;gap:10px;padding:10px 10px 18px}
    .brand img{height:28px;width:auto;display:block}
    .brand .name{font-weight:700;letter-spacing:.2px}
    .nav{display:flex;flex-direction:column;gap:6px}
    .nav a{padding:12px 12px;border-radius:12px;display:flex;align-items:center;gap:10px;color:#f1f1f1}
    .nav a:hover{background:rgba(255,255,255,.08)}
    .nav a.active{background:rgba(200,106,74,.22);border:1px solid rgba(200,106,74,.35)}
    .content{flex:1;padding:28px 28px 60px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .header h1{margin:0;font-size:34px;letter-spacing:-.4px}
    .sub{color:var(--muted);margin:6px 0 0}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card.pad{padding:18px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.18);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;border:1px solid var(--border);padding:6px 10px;color:var(--muted);font-size:13px;background:#fff}
    .pill.green{border-color:rgba(22,163,74,.35);color:var(--green)}
    .pill.red{border-color:rgba(239,68,68,.35);color:var(--red)}
    .pill.blue{border-color:rgba(37,99,235,.35);color:var(--blue)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;color:var(--muted)}
    .tab.active{border-color:rgba(200,106,74,.55);color:var(--text);box-shadow:0 10px 20px rgba(200,106,74,.10)}
    input,select,textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff;font-size:14px}
    textarea{min-height:110px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{padding:14px;border:1px solid var(--border);border-radius:14px;background:#fff;display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .item .meta{color:var(--muted);font-size:13px;margin-top:4px}
    .k{font-size:13px;color:var(--muted);margin-bottom:6px}
    .toast{position:fixed;right:18px;bottom:18px;background:#0f172a;color:#fff;border-radius:12px;padding:12px 14px;opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    .search{display:flex;gap:10px;align-items:center}
    .search input{max-width:380px}
    @media (max-width: 980px){
      .sidebar{display:none}
      .content{padding:20px}
      .col-6,.col-4,.col-3{grid-column:span 12}
      .header h1{font-size:28px}
    }
  </style>
  
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <img id="brandLogo" alt="Logo" style="display:none">
      <div class="name" id="brandName">SOP Portal</div>
    </div>
    <div class="nav">
      <a id="navCompany" href="company-overview.html">Company Overview</a>
      <a href="org-chart.html">Org Chart</a>
      <a class="active" href="departments.html">Departments</a>
      <a id="navAdmin" href="admin.html">Admin</a>
      <a href="#" id="navLogout">Sign out</a>
    </div>
  </aside>

  <main class="content">
    <div class="header">
      <div>
        <h1 id="roleTitle">Role</h1>
        <div class="sub" id="roleSub">Role hub</div>
      </div>
      <div class="search">
        <a class="btn" id="btnBack" href="departments.html">Back</a>
        <span class="pill" id="editPill" style="display:none">Editor</span>
        <span class="pill" id="userPill">Loading...</span>
      </div>
    </div>

    <div class="card pad" style="margin-bottom:14px">
      <div class="tabs" id="tabs"></div>
    </div>

    <div class="grid">
      <div class="col-12 card pad" id="panel"></div>
    </div>
  </main>
</div>

<div id="toast" class="toast"></div>

<script>

const SUPABASE_URL = '__SUPABASE_URL__';
const SUPABASE_ANON_KEY = '__SUPABASE_ANON_KEY__';
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function qs(key) {
  const url = new URL(window.location.href);
  return url.searchParams.get(key);
}
function setQs(key, val) {
  const url = new URL(window.location.href);
  if (val === null || val === undefined) url.searchParams.delete(key);
  else url.searchParams.set(key, val);
  window.history.replaceState({}, '', url.toString());
}
function toast(msg, ok=true) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.style.background = ok ? '#0f172a' : '#7f1d1d';
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2400);
}
async function requireSession(redirectTo='login.html') {
  const { data: { session } } = await sb.auth.getSession();
  if (!session) {
    window.location.href = redirectTo;
    return null;
  }
  return session;
}
function isAdmin_(me) {
  const r = (me && me.role ? me.role : '').toUpperCase();
  return r === 'CEO' || r === 'COO';
}
function applyNavVisibility_(me) {
  const admin = isAdmin_(me);
  const adminLink = document.getElementById('navAdmin');
  if (adminLink) adminLink.style.display = admin ? '' : 'none';
  const companyLink = document.getElementById('navCompany');
  if (companyLink) companyLink.style.display = admin ? '' : 'none';
}

async function getCurrentUserRow() {
  const { data: userData } = await sb.auth.getUser();
  const user = userData && userData.user ? userData.user : null;
  const email = user && user.email ? user.email.toLowerCase() : '';
  if (!email) return { email: '', role: 'Staff' };

  const { data, error } = await sb.from('users').select('*').eq('email', email).maybeSingle();
  if (error) console.warn('users lookup failed', error);

  const me = data || { email, name: email.split('@')[0], role: 'Staff' };
  try { applyNavVisibility_(me); } catch (e) {}
  return me;
}
async function loadBranding() {
  // settings: key='branding' value={ logo_path, company_name }
  const { data } = await sb.from('settings').select('*').eq('key','branding').maybeSingle();
  const v = (data && data.value) ? data.value : {};
  const logo = document.getElementById('brandLogo');
  const name = document.getElementById('brandName');
  if (name && v.company_name) name.textContent = v.company_name;
  if (logo) {
    if (v.logo_path) {
      const { data: urlData } = sb.storage.from('branding').getPublicUrl(v.logo_path);
      logo.src = urlData.publicUrl;
      logo.style.display = 'block';
    } else {
      logo.style.display = 'none';
    }
  }
}
async function canEditRole(email, roleName) {
  // CEO/COO can edit anything by default
  const me = await getCurrentUserRow();
  if (!me) return false;
  if ((me.role || '').toUpperCase() === 'CEO' || (me.role || '').toUpperCase() === 'COO') return true;
  const { data } = await sb.from('role_permissions').select('*')
    .eq('user_email', email).eq('role', roleName).maybeSingle();
  return !!(data && data.can_edit);
}
async function canApproveRole(email, roleName) {
  const me = await getCurrentUserRow();
  if (!me) return false;
  if ((me.role || '').toUpperCase() === 'CEO' || (me.role || '').toUpperCase() === 'COO') return true;
  const { data } = await sb.from('role_permissions').select('*')
    .eq('user_email', email).eq('role', roleName).maybeSingle();
  return !!(data && data.can_approve);
}
function slugify(s) {
  return (s || '')
    .toLowerCase().trim()
    .replace(/[^a-z0-9\s-]/g,'')
    .replace(/\s+/g,'-')
    .replace(/-+/g,'-');
}

let me = null;
let roleRow = null;
let hub = null;
let editable = false;

const TAB_KEYS = ['overview','responsibilities','kpis','tools','sops'];
const TAB_LABELS = {
  overview: 'Overview',
  responsibilities: 'Responsibilities',
  kpis: 'KPIs',
  tools: 'Tools and Access',
  sops: 'SOPs'
};

function renderTabs(activeKey) {
  const tabs = document.getElementById('tabs');
  tabs.innerHTML = '';
  for (const k of TAB_KEYS) {
    const b = document.createElement('button');
    b.className = 'tab' + (k===activeKey ? ' active' : '');
    b.textContent = TAB_LABELS[k];
    b.addEventListener('click', ()=> setActiveTab(k));
    tabs.appendChild(b);
  }
}

function setActiveTab(key) {
  setQs('tab', key);
  renderTabs(key);
  if (key==='overview') renderOverview();
  if (key==='responsibilities') renderResponsibilities();
  if (key==='kpis') renderKpis();
  if (key==='tools') renderTools();
  if (key==='sops') renderSops();
}

async function loadHub(roleId) {
  const { data } = await sb.from('role_hubs').select('*').eq('role_id', roleId).maybeSingle();
  if (data) return data;

  // fallback: old table sop_roles with role text
  if (roleRow && roleRow.name) {
    const old = await sb.from('sop_roles').select('*').eq('role', roleRow.name).maybeSingle();
    if (old && old.data) {
      return {
        role_id: roleId,
        content: {
          overview: old.data.role_overview || '',
          responsibilities: (old.data.responsibilities || []).map(x=> (x && x.text) ? x.text : x).filter(Boolean),
          kpis: old.data.kpis || [],
          tools: old.data.tools || []
        },
        updated_at: old.data.updated_at || null
      };
    }
  }
  return { role_id: roleId, content: { overview:'', responsibilities:[], kpis:[], tools:[] } };
}

async function saveHub() {
  if (!editable) return;
  const payload = {
    role_id: roleRow.id,
    content: hub.content,
    updated_at: new Date().toISOString(),
    updated_by: me.email
  };
  const { error } = await sb.from('role_hubs').upsert(payload, { onConflict: 'role_id' });
  if (error) { console.error(error); return toast('Save failed', false); }
  toast('Saved');
}

function renderOverview() {
  const p = document.getElementById('panel');
  const v = (hub && hub.content && hub.content.overview) ? hub.content.overview : '';
  p.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
      <div>
        <div style="font-weight:900;font-size:18px">Overview</div>
        <div class="sub">High level summary of this role.</div>
      </div>
      ${editable ? `<button class="btn primary" id="btnSave">Save</button>` : ''}
    </div>
    <div style="margin-top:12px">
      ${editable
        ? `<textarea id="overviewInput" placeholder="Write the role overview...">${escapeHtml(v)}</textarea>`
        : `<div style="white-space:pre-wrap;line-height:1.7">${escapeHtml(v || 'No overview yet.')}</div>`
      }
    </div>
  `;
  if (editable) {
    document.getElementById('btnSave').addEventListener('click', async ()=>{
      hub.content.overview = document.getElementById('overviewInput').value;
      await saveHub();
    });
  }
}

function renderResponsibilities() {
  const p = document.getElementById('panel');
  const arr = (hub && hub.content && Array.isArray(hub.content.responsibilities)) ? hub.content.responsibilities : [];
  p.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
      <div>
        <div style="font-weight:900;font-size:18px">Responsibilities</div>
        <div class="sub">What this role owns.</div>
      </div>
      ${editable ? `<button class="btn primary" id="btnSave">Save</button>` : ''}
    </div>
    <div style="margin-top:12px" class="list" id="respList"></div>
    ${editable ? `<button class="btn" id="btnAdd" style="margin-top:10px">Add Responsibility</button>` : ''}
  `;
  const list = document.getElementById('respList');
  if (!arr.length && !editable) {
    list.innerHTML = `<div class="sub">No responsibilities yet.</div>`;
    return;
  }
  arr.forEach((t, i)=>{
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div style="flex:1">
        ${editable
          ? `<input data-i="${i}" class="respInput" value="${escapeAttr(t)}">`
          : `<div style="font-weight:700;line-height:1.5">${escapeHtml(t)}</div>`
        }
      </div>
      ${editable ? `<button class="btn" data-del="${i}">Remove</button>` : ''}
    `;
    list.appendChild(row);
  });
  if (editable) {
    document.getElementById('btnAdd').addEventListener('click', ()=>{
      hub.content.responsibilities = [...arr, ''];
      renderResponsibilities();
    });
    list.querySelectorAll('[data-del]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const i = parseInt(b.getAttribute('data-del'),10);
        hub.content.responsibilities = arr.filter((_,idx)=>idx!==i);
        renderResponsibilities();
      });
    });
    document.getElementById('btnSave').addEventListener('click', async ()=>{
      const inputs = [...document.querySelectorAll('.respInput')];
      hub.content.responsibilities = inputs.map(x=>x.value.trim()).filter(Boolean);
      await saveHub();
    });
  }
}

function renderKpis() {
  const p = document.getElementById('panel');
  const arr = (hub && hub.content && Array.isArray(hub.content.kpis)) ? hub.content.kpis : [];
  p.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
      <div>
        <div style="font-weight:900;font-size:18px">KPIs</div>
        <div class="sub">How success is measured.</div>
      </div>
      ${editable ? `<button class="btn primary" id="btnSave">Save</button>` : ''}
    </div>
    <div style="margin-top:12px" class="list" id="kpiList"></div>
    ${editable ? `<button class="btn" id="btnAdd" style="margin-top:10px">Add KPI</button>` : ''}
  `;
  const list = document.getElementById('kpiList');
  if (!arr.length && !editable) {
    list.innerHTML = `<div class="sub">No KPIs yet.</div>`;
    return;
  }
  arr.forEach((k, i)=>{
    const name = (k && k.name) ? k.name : (typeof k === 'string' ? k : '');
    const target = (k && k.target) ? k.target : '';
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div style="flex:1">
        ${editable ? `
          <div class="row">
            <input class="kpiName" data-i="${i}" placeholder="KPI name" value="${escapeAttr(name)}">
            <input class="kpiTarget" data-i="${i}" placeholder="Target (optional)" value="${escapeAttr(target)}">
          </div>
        ` : `
          <div style="font-weight:800">${escapeHtml(name || 'KPI')}</div>
          ${target ? `<div class="meta">Target: ${escapeHtml(target)}</div>` : ''}
        `}
      </div>
      ${editable ? `<button class="btn" data-del="${i}">Remove</button>` : ''}
    `;
    list.appendChild(row);
  });
  if (editable) {
    document.getElementById('btnAdd').addEventListener('click', ()=>{
      hub.content.kpis = [...arr, { name:'', target:'' }];
      renderKpis();
    });
    list.querySelectorAll('[data-del]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const i = parseInt(b.getAttribute('data-del'),10);
        hub.content.kpis = arr.filter((_,idx)=>idx!==i);
        renderKpis();
      });
    });
    document.getElementById('btnSave').addEventListener('click', async ()=>{
      const names = [...document.querySelectorAll('.kpiName')];
      const targets = [...document.querySelectorAll('.kpiTarget')];
      const out = names.map((n, idx)=>({ name:n.value.trim(), target:(targets[idx]?.value||'').trim() }))
        .filter(x=>x.name);
      hub.content.kpis = out;
      await saveHub();
    });
  }
}

function renderTools() {
  const p = document.getElementById('panel');
  const arr = (hub && hub.content && Array.isArray(hub.content.tools)) ? hub.content.tools : [];
  p.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
      <div>
        <div style="font-weight:900;font-size:18px">Tools and Access</div>
        <div class="sub">Links, credentials location, and access notes.</div>
      </div>
      ${editable ? `<button class="btn primary" id="btnSave">Save</button>` : ''}
    </div>
    <div style="margin-top:12px" class="list" id="toolList"></div>
    ${editable ? `<button class="btn" id="btnAdd" style="margin-top:10px">Add Tool</button>` : ''}
  `;
  const list = document.getElementById('toolList');
  if (!arr.length && !editable) {
    list.innerHTML = `<div class="sub">No tools yet.</div>`;
    return;
  }
  arr.forEach((k, i)=>{
    const name = (k && k.name) ? k.name : (typeof k === 'string' ? k : '');
    const url = (k && k.url) ? k.url : '';
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div style="flex:1">
        ${editable ? `
          <div class="row">
            <input class="toolName" data-i="${i}" placeholder="Tool name" value="${escapeAttr(name)}">
            <input class="toolUrl" data-i="${i}" placeholder="URL (optional)" value="${escapeAttr(url)}">
          </div>
        ` : `
          <div style="font-weight:800">${escapeHtml(name || 'Tool')}</div>
          ${url ? `<div class="meta"><a href="${escapeAttr(url)}" target="_blank">${escapeHtml(url)}</a></div>` : ''}
        `}
      </div>
      ${editable ? `<button class="btn" data-del="${i}">Remove</button>` : ''}
    `;
    list.appendChild(row);
  });
  if (editable) {
    document.getElementById('btnAdd').addEventListener('click', ()=>{
      hub.content.tools = [...arr, { name:'', url:'' }];
      renderTools();
    });
    list.querySelectorAll('[data-del]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const i = parseInt(b.getAttribute('data-del'),10);
        hub.content.tools = arr.filter((_,idx)=>idx!==i);
        renderTools();
      });
    });
    document.getElementById('btnSave').addEventListener('click', async ()=>{
      const names = [...document.querySelectorAll('.toolName')];
      const urls = [...document.querySelectorAll('.toolUrl')];
      const out = names.map((n, idx)=>({ name:n.value.trim(), url:(urls[idx]?.value||'').trim() }))
        .filter(x=>x.name);
      hub.content.tools = out;
      await saveHub();
    });
  }
}

async function renderSops() {
  const p = document.getElementById('panel');
  p.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
      <div>
        <div style="font-weight:900;font-size:18px">SOPs</div>
        <div class="sub">Categories and SOP pages for this role.</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        ${editable ? `<button class="btn" id="btnNewCat">New Category</button>` : ''}
        ${editable ? `<button class="btn primary" id="btnNewSop">New SOP</button>` : ''}
      </div>
    </div>
    <div style="margin-top:12px" class="grid">
      <div class="col-4 card pad">
        <div style="font-weight:900;margin-bottom:10px">Categories</div>
        <div class="list" id="catList"></div>
      </div>
      <div class="col-8 card pad">
        <div style="font-weight:900;margin-bottom:10px" id="sopListTitle">SOPs</div>
        <div class="list" id="sopList"></div>
      </div>
    </div>
  `;

  const { data: cats, error: cErr } = await sb.from('sop_categories')
    .select('*').eq('role_id', roleRow.id).order('sort_order', { ascending:true });

  if (cErr) { console.error(cErr); toast('Failed to load categories', false); }

  const catList = document.getElementById('catList');
  catList.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.className = 'btn';
  allBtn.textContent = 'All';
  allBtn.addEventListener('click', ()=> loadSopList(null, 'All'));
  catList.appendChild(allBtn);

  (cats || []).forEach(cat=>{
    const b = document.createElement('button');
    b.className = 'btn';
    b.textContent = cat.name;
    b.addEventListener('click', ()=> loadSopList(cat.id, cat.name));
    catList.appendChild(b);
  });

  await loadSopList(null, 'All');

  if (editable) {
    document.getElementById('btnNewCat').addEventListener('click', async ()=>{
      const name = prompt('Category name');
      if (!name) return;
      const payload = { role_id: roleRow.id, name: name.trim(), sort_order: 100 };
      const { error } = await sb.from('sop_categories').insert(payload);
      if (error) { console.error(error); return toast('Create category failed', false); }
      toast('Category created');
      renderSops();
    });

    document.getElementById('btnNewSop').addEventListener('click', async ()=>{
      const title = prompt('SOP title');
      if (!title) return;
      const slug = slugify(roleRow.name + '-' + title);
      const payload = {
        role_id: roleRow.id,
        category_id: null,
        title: title.trim(),
        slug,
        content: { blocks: [] },
        status: 'draft',
        created_by: me.email,
        updated_by: me.email,
        updated_at: new Date().toISOString(),
        requires_ack: false
      };
      const { error } = await sb.from('sop_pages').insert(payload);
      if (error) { console.error(error); return toast('Create SOP failed (slug may already exist)', false); }
      toast('SOP created');
      window.location.href = 'sop-page.html?slug=' + encodeURIComponent(slug);
    });
  }
}

async function loadSopList(categoryId, categoryName) {
  document.getElementById('sopListTitle').textContent = categoryName ? ('SOPs - ' + categoryName) : 'SOPs';
  let q = sb.from('sop_pages').select('id,title,slug,status,updated_at,requires_ack').eq('role_id', roleRow.id).order('updated_at', { ascending:false });
  if (categoryId) q = q.eq('category_id', categoryId);

  const { data, error } = await q;
  if (error) { console.error(error); return toast('Failed to load SOPs', false); }

  const list = document.getElementById('sopList');
  list.innerHTML = '';
  const rows = data || [];
  if (!rows.length) {
    list.innerHTML = '<div class="sub">No SOPs yet.</div>';
    return;
  }
  rows.forEach(p=>{
    const a = document.createElement('a');
    a.className = 'item';
    a.href = 'sop-page.html?slug=' + encodeURIComponent(p.slug);
    const st = (p.status || 'draft');
    const pill = st==='published' ? 'green' : (st==='in_review' ? 'blue' : '');
    a.innerHTML = `
      <div>
        <div style="font-weight:900">${escapeHtml(p.title)}</div>
        <div class="meta">Updated ${new Date(p.updated_at).toLocaleString()}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        ${p.requires_ack ? `<span class="pill">Ack</span>` : ''}
        <span class="pill ${pill}">${escapeHtml(st.replace('_',' '))}</span>
      </div>
    `;
    list.appendChild(a);
  });
}

function escapeHtml(s) {
  return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function escapeAttr(s) { return escapeHtml(s).replace(/"/g,'&quot;'); }

(async ()=>{
  await requireSession();
  await loadBranding();
  me = await getCurrentUserRow();
  document.getElementById('userPill').textContent = (me.name || me.email) + ' - ' + (me.role || 'Staff');

  const roleId = qs('role_id');
  if (!roleId) { toast('Missing role_id', false); return; }

  const { data: r, error: rErr } = await sb.from('roles').select('*').eq('id', roleId).maybeSingle();
  if (rErr || !r) { console.error(rErr); toast('Role not found', false); return; }
  roleRow = r;

  const { data: dept } = await sb.from('departments').select('*').eq('id', roleRow.department_id).maybeSingle();
  document.getElementById('roleTitle').textContent = roleRow.name;
  document.getElementById('roleSub').textContent = dept ? dept.name : 'Role hub';
  if (dept) document.getElementById('btnBack').href = 'department.html?id=' + encodeURIComponent(dept.id);

  editable = await canEditRole(me.email, roleRow.name);
  if (editable) document.getElementById('editPill').style.display='inline-flex';

  hub = await loadHub(roleRow.id);
  if (!hub.content) hub.content = { overview:'', responsibilities:[], kpis:[], tools:[] };

  const tab = qs('tab') || 'overview';
  setActiveTab(TAB_KEYS.includes(tab) ? tab : 'overview');
})();

document.getElementById('navLogout').addEventListener('click', async (e)=>{
  e.preventDefault();
  await sb.auth.signOut();
  window.location.href = 'login.html';
});

</script>
</body>
</html>